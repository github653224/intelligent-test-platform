# 性能测试需求验证脚本

## 概述

`test_performance_requirement.py` 是一个完整的测试脚本，用于验证性能测试功能，特别是针对以下需求：

**测试需求：**
对 https://baidu.com 接口进行 135 并发用户持续 30 秒的压力测试，缓慢加压，可以 2s 加到 50 用户，3s 加到 100 用户，5s 加到 135 用户，在持续运行 30s，在 3s 内缓慢减少用户到 0。

## 功能

该测试脚本包含以下测试场景：

### 1. AI 生成模式测试
- 测试 AI 直接生成 k6 脚本
- 验证脚本包含所有必要的配置（stages、target、duration 等）
- 检查脚本的正确性和完整性

### 2. 正则匹配生成模式测试
- 测试正则匹配方式生成 k6 脚本
- 验证生成速度

### 3. 创建并执行场景测试
- 测试正常创建流程（使用前端生成的脚本）
- 测试执行功能
- 模拟脚本生成失败的情况
- 测试空脚本的处理

### 4. 错误处理测试
- 测试各种错误场景的处理

## 使用方法

### 前置条件

1. **启动后端服务**
   ```bash
   # 在 backend 目录
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

2. **启动 AI 引擎服务**
   ```bash
   # 在 ai_engine 目录
   python main.py
   # 或
   uvicorn main:app --reload --host 0.0.0.0 --port 8001
   ```

3. **确保有项目存在**
   - 测试需要至少一个项目 ID
   - 如果没有项目，请先通过前端或 API 创建一个项目

### 运行测试

```bash
# 在项目根目录
python test_performance_requirement.py
```

### 测试输出

测试脚本会输出详细的测试结果，包括：
- ✅ 成功标识
- ❌ 失败标识
- ⚠️  警告标识
- 📋 测试步骤说明
- 💡 提示和建议

## 测试场景详解

### 场景 1: AI 生成模式
- **目的**: 验证 AI 生成模式是否能正确生成 k6 脚本
- **超时设置**: 180 秒（3 分钟）
- **验证点**:
  - 脚本是否包含 `stages` 配置
  - 是否包含正确的 `target` 值（50, 100, 135, 0）
  - 是否包含正确的 `duration` 值（2s, 3s, 5s, 30s）
  - 是否包含 `baidu.com`
  - 是否包含必要的导入和函数

### 场景 2: 正则匹配生成模式
- **目的**: 验证正则匹配模式是否能快速生成脚本
- **超时设置**: 30 秒
- **验证点**: 脚本生成速度和正确性

### 场景 3: 创建并执行场景
- **目的**: 验证完整的创建和执行流程
- **步骤**:
  1. 生成脚本
  2. 创建测试（使用已生成的脚本）
  3. 执行测试
  4. 验证错误处理

### 场景 4: 错误处理
- **目的**: 验证各种错误场景的处理
- **测试点**:
  - 空需求描述
  - 空脚本
  - 脚本生成失败

## 关键改进

### 1. 避免重复生成脚本
- **前端**: 生成脚本后，将脚本传递给后端
- **后端**: 如果收到脚本，直接使用；否则生成新脚本
- **优势**: 减少重复生成，提高效率

### 2. 增强错误处理
- **创建时**: 如果脚本生成失败，拒绝创建测试
- **执行时**: 如果脚本不存在或为空，拒绝执行并给出明确错误
- **优势**: 防止创建无脚本的测试，避免执行失败

### 3. 超时优化
- **AI 生成模式**: 180 秒超时
- **正则匹配模式**: 30 秒超时
- **优势**: 根据模式调整超时时间，避免不必要的等待

## 故障排查

### 问题 1: 测试脚本无法连接后端
**解决方案**:
- 检查后端服务是否启动: `curl http://localhost:8000/health`
- 检查端口是否正确

### 问题 2: AI 生成超时
**解决方案**:
- 检查 AI 引擎服务是否启动: `curl http://localhost:8001/health`
- 检查 AI 模型服务（Ollama/Deepseek）是否可用
- 查看后端日志了解详细错误

### 问题 3: 没有项目
**解决方案**:
- 通过前端或 API 创建一个项目
- 确保项目 ID 存在

### 问题 4: 脚本生成失败
**解决方案**:
- 检查需求描述是否正确
- 检查 AI 服务是否正常运行
- 查看后端日志了解详细错误
- 尝试使用正则匹配模式

## 注意事项

1. **AI 生成模式可能需要较长时间**（30-120 秒），请耐心等待
2. **确保所有服务都已启动**（后端、AI 引擎、AI 模型服务）
3. **确保至少有一个项目存在**
4. **如果测试失败，查看详细的错误信息**，根据错误信息进行排查

## 相关文件

- `test_performance_requirement.py`: 测试脚本
- `backend/app/api/v1/endpoints/performance_tests.py`: 后端 API
- `frontend/src/pages/PerformanceTests.tsx`: 前端页面
- `ai_engine/processors/k6_test_generator.py`: K6 脚本生成器

## 更新日志

### 2024-12-XX
- 初始版本
- 支持 AI 生成模式和正则匹配模式
- 支持创建并执行场景测试
- 增强错误处理
- 优化超时设置

