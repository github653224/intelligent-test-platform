# K6 脚本生成器优化分析

## 📊 当前实现分析

### ✅ 已实现功能

1. **基础脚本生成**
   - 支持 GET 请求
   - 支持基本负载配置（VUs, duration, stages）
   - 支持两种生成模式：regex（正则匹配）和 ai（AI直接生成）
   - 脚本清理功能（移除重复定义的内置指标）

2. **参数提取**
   - 从测试描述中提取 VUs、duration、URL
   - 支持多种表达方式（并发用户、VUs、虚拟用户等）
   - AI 补充提取（当正则提取不完整时）

3. **脚本验证和清理**
   - 验证脚本基本有效性
   - 自动清理重复定义的内置指标
   - 防止 `data_sent`、`data_received` 等内置指标被重复定义

### ❌ 当前限制

1. **HTTP 方法支持有限**
   - 主要支持 GET 请求
   - 不支持 POST、PUT、DELETE、PATCH 等方法
   - 无法处理请求体（JSON、表单数据、文件上传）

2. **认证支持不足**
   - 不支持 Bearer token
   - 不支持 Basic auth
   - 不支持 Cookie 认证
   - 不支持自定义 header

3. **测试场景单一**
   - 只能测试单个接口
   - 不支持多步骤测试（如：先登录，再执行操作）
   - 不支持数据驱动测试（CSV、JSON 数据文件）

4. **检查点功能基础**
   - 只有基本的状态码和响应时间检查
   - 不支持 JSON 结构验证
   - 不支持业务逻辑验证
   - 不支持响应数据提取和复用

5. **自定义指标支持不足**
   - 不支持自定义 Trend、Rate、Counter 指标
   - 虽然有清理功能，但无法区分自定义指标和内置指标

6. **高级功能缺失**
   - 不支持 `handleSummary` 函数
   - 不支持参数化 URL
   - 不支持动态数据生成（如：随机数据、时间戳）

## 🎯 用户提供的复杂脚本示例分析

### 示例1：基础 POST 请求脚本
**特点：**
- POST 请求，带 JSON 请求体
- 使用 `__VU` 和 `__ITER` 生成动态数据
- 多层检查点（状态码、响应时间、JSON 格式、业务逻辑）
- 自定义 header（Content-Type、User-Agent）

**当前项目支持情况：** ❌ 不支持

### 示例2：高级 POST 请求脚本
**特点：**
- 自定义指标（Trend、Rate、Counter）
- 多个测试函数（testJSONAPI、testFormData）
- 文件上传支持
- 错误处理和日志记录
- `handleSummary` 函数

**当前项目支持情况：** ❌ 不支持

### 示例3：登录 API 测试
**特点：**
- 多用户凭证轮询
- 认证 token 提取和验证
- 多步骤测试场景

**当前项目支持情况：** ❌ 不支持

## 💡 优化方案

### 方案1：增强参数提取（短期优化）

#### 1.1 扩展请求方法识别
- 从测试描述中识别 HTTP 方法（POST、PUT、DELETE 等）
- 支持多种表达方式：
  - "POST 请求"、"提交数据"、"创建用户"
  - "PUT 请求"、"更新数据"
  - "DELETE 请求"、"删除数据"

#### 1.2 扩展请求体识别
- 识别 JSON 请求体需求
- 识别表单数据需求
- 识别文件上传需求

#### 1.3 扩展认证识别
- 识别 Bearer token 需求
- 识别 Basic auth 需求
- 识别 Cookie 认证需求

### 方案2：增强提示词（中期优化）

#### 2.1 根据需求自动调整提示词
- 如果检测到 POST 请求，提供 POST 请求模板
- 如果检测到登录场景，提供多步骤测试模板
- 如果检测到文件上传，提供文件上传模板

#### 2.2 增强提示词内容
- 添加 POST 请求示例
- 添加自定义指标使用指南（避免与内置指标冲突）
- 添加多步骤测试示例
- 添加认证示例

### 方案3：扩展 Schema 和 API（中期优化）

#### 3.1 扩展 `K6ScriptGenerateRequest` Schema
```python
class K6ScriptGenerateRequest(BaseModel):
    test_description: str
    target_url: Optional[str] = None
    load_config: Optional[Dict[str, Any]] = None
    generation_mode: str = "regex"
    
    # 新增字段
    http_method: Optional[str] = None  # GET, POST, PUT, DELETE, PATCH
    request_body: Optional[Dict[str, Any]] = None  # 请求体配置
    headers: Optional[Dict[str, str]] = None  # 自定义 header
    auth: Optional[Dict[str, Any]] = None  # 认证配置
    test_steps: Optional[List[Dict[str, Any]]] = None  # 多步骤测试配置
    custom_metrics: Optional[List[Dict[str, Any]]] = None  # 自定义指标配置
    checks: Optional[List[Dict[str, Any]]] = None  # 检查点配置
```

#### 3.2 扩展前端表单
- 添加 HTTP 方法选择器
- 添加请求体编辑器（JSON 编辑器）
- 添加 Header 编辑器
- 添加认证配置表单
- 添加测试步骤配置（多步骤测试）

### 方案4：智能脚本生成（长期优化）

#### 4.1 场景识别
- **登录场景**：自动生成登录→获取token→使用token的测试流程
- **CRUD 场景**：自动生成创建→读取→更新→删除的测试流程
- **文件上传场景**：自动生成文件上传测试
- **API 链场景**：自动生成多个 API 串联测试

#### 4.2 智能参数提取
- 使用 AI 识别测试场景
- 自动提取请求体结构
- 自动识别认证方式
- 自动生成检查点

#### 4.3 模板系统
- 为常见场景创建模板
- 支持模板自定义
- 支持模板组合

## 🚀 推荐实施路径

### 第一阶段：基础增强（1-2周）
1. **扩展参数提取**
   - 识别 HTTP 方法（POST、PUT、DELETE）
   - 识别请求体需求（JSON、表单）
   - 识别认证需求（Bearer token、Basic auth）

2. **增强提示词**
   - 添加 POST 请求示例
   - 添加认证示例
   - 添加自定义指标使用指南

3. **扩展脚本生成逻辑**
   - 支持 POST 请求生成
   - 支持请求体生成
   - 支持自定义 header 生成

### 第二阶段：功能扩展（2-3周）
1. **扩展 Schema 和 API**
   - 添加新的请求字段
   - 更新前端表单
   - 更新后端处理逻辑

2. **多步骤测试支持**
   - 支持测试步骤配置
   - 支持步骤间数据传递
   - 支持条件执行

3. **自定义指标支持**
   - 支持自定义 Trend、Rate、Counter
   - 确保不与内置指标冲突
   - 提供指标使用示例

### 第三阶段：高级功能（3-4周）
1. **场景识别**
   - 实现场景识别逻辑
   - 创建场景模板
   - 支持模板自定义

2. **数据驱动测试**
   - 支持 CSV 数据文件
   - 支持 JSON 数据文件
   - 支持动态数据生成

3. **高级检查点**
   - 支持 JSON 结构验证
   - 支持业务逻辑验证
   - 支持响应数据提取

## 📝 具体优化建议

### 1. 提示词优化

#### 当前提示词问题：
- 主要关注 GET 请求
- 没有 POST 请求示例
- 没有认证示例
- 没有自定义指标使用指南

#### 优化后的提示词应该包含：
1. **POST 请求示例**
   ```javascript
   // POST 请求示例
   const payload = JSON.stringify({
     userId: __VU,
     requestId: __ITER,
     timestamp: Date.now()
   });
   const response = http.post(url, payload, {
     headers: { 'Content-Type': 'application/json' }
   });
   ```

2. **认证示例**
   ```javascript
   // Bearer token 认证
   const headers = {
     'Authorization': 'Bearer your-token-here'
   };
   ```

3. **自定义指标示例**
   ```javascript
   // 自定义指标（避免与内置指标冲突）
   const customResponseTime = new Trend('custom_response_time');
   const successRate = new Rate('custom_success_rate');
   // 注意：不要创建 data_sent, data_received 等内置指标
   ```

4. **多步骤测试示例**
   ```javascript
   // 多步骤测试
   export default function() {
     // 步骤1：登录
     const loginResponse = http.post(loginUrl, loginPayload);
     const token = JSON.parse(loginResponse.body).token;
     
     // 步骤2：使用 token 访问受保护的资源
     const headers = { 'Authorization': `Bearer ${token}` };
     const protectedResponse = http.get(protectedUrl, { headers });
   }
   ```

### 2. 参数提取优化

#### 当前参数提取问题：
- 只提取 VUs、duration、URL
- 不提取 HTTP 方法
- 不提取请求体
- 不提取认证信息

#### 优化后的参数提取应该包含：
1. **HTTP 方法提取**
   - 识别 "POST 请求"、"提交数据"、"创建用户"
   - 识别 "PUT 请求"、"更新数据"
   - 识别 "DELETE 请求"、"删除数据"

2. **请求体提取**
   - 识别 JSON 请求体需求
   - 识别表单数据需求
   - 识别文件上传需求

3. **认证提取**
   - 识别 "Bearer token"、"JWT 认证"
   - 识别 "Basic auth"、"用户名密码"
   - 识别 "Cookie 认证"

### 3. 脚本生成逻辑优化

#### 当前生成逻辑问题：
- 只生成 GET 请求
- 不生成请求体
- 不生成认证 header
- 不生成自定义指标

#### 优化后的生成逻辑应该：
1. **根据 HTTP 方法生成不同的请求**
   - GET：`http.get(url, params)`
   - POST：`http.post(url, payload, params)`
   - PUT：`http.put(url, payload, params)`
   - DELETE：`http.delete(url, params)`

2. **根据需求生成请求体**
   - JSON：`JSON.stringify({ ... })`
   - 表单：`{ key: value }`
   - 文件：`http.file(...)`

3. **根据需求生成认证**
   - Bearer token：`'Authorization': 'Bearer token'`
   - Basic auth：`'Authorization': 'Basic base64(username:password)'`
   - Cookie：`cookies: { ... }`

4. **根据需求生成自定义指标**
   - 只有在需要时才创建自定义指标
   - 确保不与内置指标冲突
   - 提供指标使用示例

### 4. 前端表单优化

#### 当前表单问题：
- 只有基本的测试描述和 URL
- 没有 HTTP 方法选择
- 没有请求体编辑器
- 没有认证配置

#### 优化后的表单应该包含：
1. **HTTP 方法选择器**
   - 单选：GET、POST、PUT、DELETE、PATCH

2. **请求体编辑器**
   - JSON 编辑器（代码高亮）
   - 表单数据编辑器
   - 文件上传选择器

3. **Header 编辑器**
   - Key-Value 编辑器
   - 常用 header 快速选择

4. **认证配置**
   - Bearer token 输入
   - Basic auth 输入（用户名、密码）
   - Cookie 输入

5. **测试步骤配置**
   - 多步骤测试配置
   - 步骤间数据传递配置

## 🎨 用户体验优化

### 1. 智能默认值
- 根据测试描述自动填充 HTTP 方法
- 根据测试描述自动填充请求体结构
- 根据测试描述自动填充认证方式

### 2. 实时预览
- 实时预览生成的脚本
- 实时验证脚本语法
- 实时提示潜在问题

### 3. 模板选择
- 提供常见场景模板
- 支持模板自定义
- 支持模板保存和复用

## 📊 技术实现细节

### 1. 参数提取增强
```python
def _extract_http_method(self, test_description: str) -> str:
    """提取 HTTP 方法"""
    patterns = {
        'POST': [r'POST', r'提交', r'创建', r'添加'],
        'PUT': [r'PUT', r'更新', r'修改'],
        'DELETE': [r'DELETE', r'删除', r'移除'],
        'PATCH': [r'PATCH', r'部分更新'],
    }
    # 实现逻辑...
```

### 2. 请求体生成
```python
def _generate_request_body(self, test_description: str, http_method: str) -> str:
    """生成请求体"""
    if http_method in ['POST', 'PUT', 'PATCH']:
        # 使用 AI 生成请求体结构
        # 或从测试描述中提取
        pass
```

### 3. 认证生成
```python
def _generate_auth_headers(self, test_description: str) -> Dict[str, str]:
    """生成认证 header"""
    if 'bearer' in test_description.lower() or 'token' in test_description.lower():
        return {'Authorization': 'Bearer your-token-here'}
    # 其他认证方式...
```

## 🔍 测试策略

### 1. 单元测试
- 测试参数提取逻辑
- 测试脚本生成逻辑
- 测试脚本清理逻辑

### 2. 集成测试
- 测试完整生成流程
- 测试不同场景的脚本生成
- 测试脚本执行结果

### 3. 用户测试
- 收集用户反馈
- 优化用户体验
- 持续改进

## 📈 预期效果

### 1. 功能增强
- ✅ 支持多种 HTTP 方法
- ✅ 支持请求体生成
- ✅ 支持认证配置
- ✅ 支持多步骤测试
- ✅ 支持自定义指标

### 2. 用户体验提升
- ✅ 更直观的表单
- ✅ 更智能的默认值
- ✅ 更实时预览
- ✅ 更多模板选择

### 3. 脚本质量提升
- ✅ 更符合实际使用场景
- ✅ 更完善的检查点
- ✅ 更详细的监控指标
- ✅ 更好的错误处理

## 🎯 下一步行动

1. **立即开始**：增强提示词，添加 POST 请求示例
2. **短期目标**：扩展参数提取，支持 HTTP 方法识别
3. **中期目标**：扩展 Schema 和 API，支持更多配置
4. **长期目标**：实现场景识别和模板系统

## 📚 参考资料

1. [k6 官方文档](https://k6.io/docs/)
2. [k6 JavaScript API](https://k6.io/docs/javascript-api/)
3. [k6 示例脚本](https://github.com/grafana/k6/tree/master/samples)
4. 用户提供的复杂脚本示例

## 💬 总结

当前项目的 k6 脚本生成器已经实现了基础功能，但在处理复杂场景（POST 请求、认证、多步骤测试等）方面还有很大的改进空间。通过分阶段实施优化方案，可以逐步提升脚本生成器的功能性和用户体验，使其能够处理更多实际的性能测试场景。

建议优先实施第一阶段的优化（基础增强），这样可以快速提升对 POST 请求和认证的支持，满足大部分用户的需求。然后再逐步实施后续阶段的优化，实现更高级的功能。

